# video encoder micro service (made by full cycle)

## Environment config

to run the application in dev mode:

* Duplicate the `.env.example` file and rename to `.env`
* Run docker-compose up -d
* Access the rabbitmq administration and create an exchange of `fannout` type. It will be a `Dead Letter Exchange` to receive not unprocessed messages.
* Create a `Dead Letter Queue` and bind it with the same `Dead Letter Exchange` that has been created. There's no need of routing_key.
* In the `.env` file choose a name of `Dead Letter Exchange` in the param: `RABBITMQ_DLX`
* Create a service account in GCP that has permission to write into google cloud storage. Download the json file with the credentials and save it on project root with the name: `bucket-credential.json`

## Running

To run the encoder run the command `make server` directly from container. Example:

```
docker exec app make server
```

`app` is the name of the container generated by docker-compose.

## Padrão de envio de mensagem para o encoder

Para que uma mensagem possa ser parseada pelo sistema de encoder, ela deverá chegar no seguinte formato em json:

```
{
  "resource_id": "my-resource-id-can-be-a-uuid-type",
  "file_path": "convite.mp4"
}
```

* `resource_id`: Representa o ID do vídeo que você deseja converter. Ele é do tipo string.
* `file_path`: É o caminho completo do vídeo mp4 dentro do bucket.

## Encoder message return pattern

### Sucess

For each processed video, the encoder will send to an exchange (setted at .env) the processed result.

If processing has been completed successfully, the return patter in json wil be:

```
{
    "id":"bbbdd123-ad05-4dc8-a74c-d63a0a2423d5",
    "output_bucket_path":"bucket",
    "status":"COMPLETED",
    "video":{
        "encoded_video_folder":"b3f2d41e-2c0a-4830-bd65-68227e97764f",
        "resource_id":"aadc5ff9-0b0d-13ab-4a40-a11b2eaa148c",
        "file_path":"video.mp4"
    },
    "Error":"",
    "created_at":"2020-05-27T19:43:34.850479-04:00",
    "updated_at":"2020-05-27T19:43:38.081754-04:00"
}
```

`encoded_video_folder` is the folder that contains the converted video.

### Error

If the processing found an error, the return patter in json wil be:

```
{
    "message": {
        "resource_id": "aadc5ff9-010d-a3ab-4a40-a11b2eaa148c",
        "file_path": "convite.mp4"
    },
    "error":"error motive"
}
```

Besides that, the encoder will send to an dead letter exchange the original message that had a problem during the processing.
You just need to set the DLX in the .env file at `RABBITMQ_DLX` parameter